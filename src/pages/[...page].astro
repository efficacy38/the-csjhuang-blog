---
import { siteConfig } from "../config";
import MainLayout from "../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import Pagination from "../components/Pagination.astro";
import type { CollectionEntry } from "astro:content";
import type { Page } from "astro";
import { Icon } from "astro-icon/components";
import { getSeriesInfo } from "../utils/series";

export async function getStaticPaths({ paginate }) {
    const posts = await getCollection("posts", ({ data }) => {
        return import.meta.env.PROD ? data.status !== "draft" : true;
    });

    // Extract numeric ID from filePath (e.g., "src/content/posts/kerberos-001-name.md" -> 1)
    const getNumericId = (filePath: string): number => {
        const match = filePath.match(/-(\d+)-/);
        return match ? parseInt(match[1], 10) : 0;
    };

    // Sort by pinned first, then by date, then by numeric ID for series
    posts.sort((a, b) => {
        if (a.data.isPinned && !b.data.isPinned) return -1;
        if (!a.data.isPinned && b.data.isPinned) return 1;
        const dateDiff = b.data.date.valueOf() - a.data.date.valueOf();
        if (dateDiff !== 0) return dateDiff;
        // Same date: sort by numeric ID ascending so 000 < 001 < 002 < 003
        return getNumericId((a as any).filePath || '') - getNumericId((b as any).filePath || '');
    });

    return paginate(posts, { pageSize: siteConfig.page_size });
}

interface Props {
    page: Page<CollectionEntry<"posts">>;
}

const { page } = Astro.props;

// Get all posts for series info calculation
const allPosts = await getCollection("posts", ({ data }) => {
    return import.meta.env.PROD ? data.status !== "draft" : true;
});
---

<MainLayout>
    <div class="grow">
        <ul class="space-y-4">
            {
                page.data.map((post) => (
                    <li>
                        <a
                            class="min-h-36 card p-4 flex gap-4 group"
                            href={`/posts/${post.data.slug}/`}
                        >
                            {post.data.heroImage && (
                                <img
                                    src={post.data.heroImage}
                                    alt=""
                                    class="thumbnail"
                                    loading="lazy"
                                />
                            )}
                            <div class="flex flex-col grow min-w-0">
                                <div class="flex items-center gap-2">
                                    {post.data.isPinned && (
                                        <Icon
                                            class="w-5 h-5 text-accent shrink-0"
                                            name="material-symbols:push-pin"
                                        />
                                    )}
                                    <h2 class="text-xl font-bold line-clamp-1 text-primary group-hover:text-accent transition-colors" transition:name={`title-${post.data.slug}`}>
                                        {post.data.title}
                                    </h2>
                                </div>
                                {(() => {
                                    const seriesInfo = getSeriesInfo(allPosts, post);
                                    return seriesInfo && (
                                        <div class="flex items-center gap-1.5 text-sm">
                                            <Icon class="w-4 h-4 text-accent" name="material-symbols:bookmark" />
                                            <span class="text-accent">{seriesInfo.name} 系列</span>
                                            <span class="text-secondary">({seriesInfo.part}/{seriesInfo.total})</span>
                                        </div>
                                    );
                                })()}
                                <p class="line-clamp-2 text-secondary">{post.data.description}</p>
                                <div class="mt-auto flex items-center gap-2">
                                    <div class="flex flex-wrap gap-1.5 min-w-0">
                                        {post.data.tags && post.data.tags.map((tag) => (
                                            <span class="inline-flex items-center text-xs text-secondary font-mono bg-elevated px-1.5 py-0.5 rounded hover:bg-accent/10 hover:text-primary transition-all duration-200">
                                                <Icon class="w-3 h-3 mr-1 text-accent" name="material-symbols:tag" />
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                    <time
                                        class="ml-auto text-secondary font-mono text-sm shrink-0"
                                        datetime={post.data.date.toISOString()}
                                    >
                                        {post.data.date.toLocaleDateString(
                                            siteConfig.language,
                                        )}
                                    </time>
                                </div>
                            </div>
                        </a>
                    </li>
                ))
            }
        </ul>
        <Pagination class="mt-4 w-fit ml-auto" page={page} />
    </div>
</MainLayout>
