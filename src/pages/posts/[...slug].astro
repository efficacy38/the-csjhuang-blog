---
import { getDesc, getTitle } from "../../utils";
import { siteConfig } from "../../config";
import Badge from "../../components/Badge.astro";
import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";
import PageLayout from "../../layouts/PageLayout.astro";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
    const posts = await getCollection("posts", ({ data }) => {
        return import.meta.env.PROD ? data.isDraft !== true : true;
    });

    // Sort posts by date for consistent prev/next order
    posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

    return posts.map((post, index) => ({
        params: { slug: post.data.slug },
        props: {
            post,
            prevPost: index < posts.length - 1 ? posts[index + 1] : null,
            nextPost: index > 0 ? posts[index - 1] : null,
        },
    }));
}

interface Props {
    post: CollectionEntry<"posts">;
    prevPost: CollectionEntry<"posts"> | null;
    nextPost: CollectionEntry<"posts"> | null;
}

const { post, prevPost, nextPost } = Astro.props;
const { data } = post;
const { Content, headings, remarkPluginFrontmatter } = await render(post);
const haveToc = headings.some(
    (heading) => heading.depth === 2 || heading.depth === 3,
);
---

<PageLayout
    comments={true}
    title={getTitle(data.title)}
    description={getDesc(data.description)}
>
    <div class="flex items-start">
        {
            haveToc && (
                <aside class="basis-[16rem] shrink-0 max-md:hidden sticky top-20 mr-4 bg-base border border-border transition-all rounded-xl p-3">
                    <div class="text-xs font-mono text-secondary uppercase tracking-wider mb-2 px-2">On this page</div>
                    <ul class="space-y-0.5">
                        {headings.map((heading) => {
                            switch (heading.depth) {
                                case 2:
                                    return (
                                        <li>
                                            <a
                                                class="px-2 menu-item text-sm border-l-2 border-transparent hover:border-l-accent hover:text-accent"
                                                href={`#${heading.slug}`}
                                            >
                                                {heading.text}
                                            </a>
                                        </li>
                                    );
                                case 3:
                                    return (
                                        <li>
                                            <a
                                                class="pl-5 pr-2 menu-item text-sm text-secondary border-l-2 border-transparent hover:border-l-accent hover:text-accent"
                                                href={`#${heading.slug}`}
                                            >
                                                {heading.text}
                                            </a>
                                        </li>
                                    );
                            }
                        })}
                    </ul>
                </aside>
            )
        }

        <article class="article base-card grow" data-pagefind-body>
            {data.heroImage && (
                <img
                    src={data.heroImage}
                    alt=""
                    class="hero-image not-prose mb-6"
                    loading="eager"
                    transition:name={`hero-${data.slug}`}
                />
            )}
            <h1 id={data.title} transition:name={`title-${data.slug}`}>{data.title}</h1>

            <div class="flex flex-wrap gap-2 not-prose mb-3">
                <Badge icon="material-symbols:edit-calendar-rounded">
                    {
                        new Date(
                            remarkPluginFrontmatter.lastModified,
                        ).toLocaleDateString(siteConfig.language)
                    }
                </Badge>
                {
                    siteConfig.twikoo_uri && (
                        <Badge icon="material-symbols:bar-chart-rounded">
                            <span id="twikoo_visitors">...</span>
                        </Badge>
                    )
                }
                {
                    post.data.tags &&
                        post.data.tags.map((tag) => (
                            <Badge icon="material-symbols:tag">
                                <a
                                    href={`/tags/${tag}`}
                                    class="flex p-1 justify-center"
                                >
                                    <span>{tag}</span>
                                </a>
                            </Badge>
                        ))
                }
            </div>
            <Content />

            <!-- Next/Prev Navigation -->
            <nav class="not-prose mt-8 pt-6 border-t border-border">
                <div class="flex justify-between gap-4">
                    {prevPost ? (
                        <a
                            href={`/posts/${prevPost.data.slug}/`}
                            class="flex-1 group p-4 rounded-xl border border-border hover:border-accent transition-colors"
                            data-prev-url={`/posts/${prevPost.data.slug}`}
                        >
                            <div class="flex items-center gap-2 text-secondary text-sm mb-1">
                                <Icon class="w-4 h-4" name="material-symbols:arrow-back-rounded" />
                                <span>Previous</span>
                            </div>
                            <div class="font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                                {prevPost.data.title}
                            </div>
                        </a>
                    ) : <div class="flex-1" />}
                    {nextPost ? (
                        <a
                            href={`/posts/${nextPost.data.slug}/`}
                            class="flex-1 group p-4 rounded-xl border border-border hover:border-accent transition-colors text-right"
                            data-next-url={`/posts/${nextPost.data.slug}`}
                        >
                            <div class="flex items-center justify-end gap-2 text-secondary text-sm mb-1">
                                <span>Next</span>
                                <Icon class="w-4 h-4" name="material-symbols:arrow-forward-rounded" />
                            </div>
                            <div class="font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                                {nextPost.data.title}
                            </div>
                        </a>
                    ) : <div class="flex-1" />}
                </div>
            </nav>
        </article>
    </div>

    <script>
        import { debounce } from "../../utils";

        const links = document.querySelectorAll(".menu-item");
        const handler = debounce(() => {
            for (const link of links) {
                const href = link.getAttribute("href") as string;
                const target = document.querySelector(
                    `[id="${href.slice(1)}"]`,
                );
                if (target) {
                    const offsetTop =
                        target.getBoundingClientRect().top -
                        document.body.clientHeight / 3;
                    if (offsetTop <= 0) {
                        links.forEach((link) => {
                            link.classList.remove("bg-hover", "border-l-accent", "text-accent");
                            link.classList.add("border-transparent");
                        });
                        link.classList.add("bg-hover", "border-l-accent", "text-accent");
                        link.classList.remove("border-transparent");
                        history.replaceState(null, "", href);
                    }
                }
            }
        });
        document.addEventListener("scroll", handler);
        document.addEventListener("DOMContentLoaded", handler);
    </script>

    <script>
        // Swipe gesture navigation
        let touchStartX = 0;
        let touchEndX = 0;
        const minSwipeDistance = 100;

        const handleSwipe = () => {
            const swipeDistance = touchEndX - touchStartX;
            if (Math.abs(swipeDistance) < minSwipeDistance) return;

            if (swipeDistance > 0) {
                // Swipe right -> go to previous post
                const prevLink = document.querySelector('[data-prev-url]') as HTMLAnchorElement;
                if (prevLink) {
                    window.location.href = prevLink.href;
                }
            } else {
                // Swipe left -> go to next post
                const nextLink = document.querySelector('[data-next-url]') as HTMLAnchorElement;
                if (nextLink) {
                    window.location.href = nextLink.href;
                }
            }
        };

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });
    </script>
</PageLayout>
