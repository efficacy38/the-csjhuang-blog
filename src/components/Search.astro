---

---
<div id="search-container" class="fixed hidden inset-0 z-50 bg-back/90 backdrop-blur-md animate-in fade-in overflow-hidden" transition:persist>
    <div class="absolute top-16 left-1/2 -translate-x-1/2 container-global w-full flex flex-col" style="max-height: calc(100vh - 5rem);">
        <form class="w-3/4 mx-auto max-md:w-full animate-in slide-in-from-top shrink-0">
            <label>
                <input name="search" autocomplete="off" placeholder="Search..."
                       class="w-full outline-0 bg-base border border-border focus:border-accent focus:ring-1 focus:ring-accent transition-all rounded-xl h-16 p-4 shadow-xl text-xl text-primary placeholder:text-secondary"/>
            </label>
        </form>
        <div id="search-results" class="w-3/4 mx-auto max-md:w-full overflow-y-auto rounded-xl mt-2 pb-4">

        </div>
    </div>
</div>

<script is:inline>
    const searchContainer = document.querySelector("#search-container");
    const searchInput = searchContainer?.querySelector("input")
    const searchResults = document.querySelector("#search-results")

    function openSearch() {
        searchContainer.classList.remove("hidden")
        document.body.style.overflow = "hidden"
    }

    function closeSearch() {
        searchContainer.classList.add("hidden")
        document.body.style.overflow = ""
    }

    // Close when clicking on backdrop (not on form, input, or results)
    searchContainer?.addEventListener("click", (e) => {
        if (e.target === searchContainer || e.target.closest(".container-global") === null) {
            closeSearch()
        } else if (e.target !== searchInput && !searchResults.contains(e.target) && !e.target.closest("form")) {
            closeSearch()
        }
    })
    searchContainer?.querySelector("form")?.addEventListener("submit", (e) => {
        e.preventDefault()
        // Navigate to first result on Enter
        const firstResult = document.querySelector("#search-results a")
        if (firstResult) {
            window.location.href = firstResult.href
        }
    })

    // Handle Escape key on input to close immediately
    searchInput?.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            e.preventDefault()
            closeSearch()
            searchInput.blur()
        }
    })

    // Expose functions globally for Header to use
    window.openSearch = openSearch
    window.closeSearch = closeSearch

    const cancelablePromise = promise => {
        const controller = new AbortController()
        const signal = controller.signal

        const wrappedPromise = new Promise((resolve, reject) => {
            signal.addEventListener("abort", () => {
                reject('Promise Aborted')
            })

            promise.then(resolve, reject)
        })

        return {
            promise: wrappedPromise,
            cancel: () => controller.abort()
        }
    }
    let abort = null
    searchInput.addEventListener("input", async e => {
        if (e.target.dataset.loaded !== 'true') {
            e.target.dataset.loaded = 'true'
            window.pagefind = await import("/pagefind/pagefind.js");
            pagefind.init()
        }

        const input = e.target.value.trim()
        if (input.length) {
            const search = await pagefind.debouncedSearch(input)
            if (search === null) {
                return
            }

            abort && abort()
            const searchResults = document.querySelector("#search-results")
            searchResults.innerHTML = ""
            abort = cancelablePromise(new Promise(async resolve => {
                for (const result of search.results) {
                    const data = await result.data()
                    searchResults.innerHTML += `
                    <a href="${data.url}" class="block px-4 py-3 rounded-xl bg-base border border-border animate-in fade-in mt-2 first:mt-0 hover:border-l-accent hover:border-l-2 transition-all group">
                        <h2 class="text-lg font-bold line-clamp-1 text-primary group-hover:text-accent transition-colors">${data.meta.title}</h2>
                        <p class="line-clamp-2 text-secondary text-sm mt-1">${data.excerpt}</p>
                    </a>
                `
                }
                resolve()
            })).cancel
        }
    })
</script>