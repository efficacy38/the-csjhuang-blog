---
import {siteConfig, navBarConfig} from "../config";
import {Icon} from 'astro-icon/components'
import {getCollection} from 'astro:content'

// Check which collections have content
const allNotes = await getCollection("notes");
const hasNotes = allNotes.some(note => import.meta.env.DEV || note.data.status !== "draft");
const hasProjects = (await getCollection("projects")).length > 0;
const hasLinks = (await getCollection("links")).length > 0;

// Filter nav links based on content availability
const hiddenIfEmpty: Record<string, boolean> = {
    "/notes": hasNotes,
    "/projects": hasProjects,
    "/links": hasLinks,
};

const filteredLinks = navBarConfig.links.filter(link => {
    // If the link is in hiddenIfEmpty, only show if it has content
    if (link.url in hiddenIfEmpty) {
        return hiddenIfEmpty[link.url];
    }
    // Always show other links
    return true;
});
---

<header class="fixed h-16 w-full blur-global z-10 border-t-[3px] border-t-accent">
    <div class="container-global h-full flex items-center justify-between">
        <!-- Left: Site title -->
        <div class="text-xl font-bold cursor-pointer font-mono shrink-0">
            <a href="/" class="text-primary hover:text-accent transition-colors">{siteConfig.title}</a>
        </div>

        <!-- Center: Navigation tabs -->
        <nav class="hidden sm:flex items-center gap-8">
            {
                filteredLinks.map((link) => {
                    return (
                            <a class="text-secondary hover:text-accent transition-colors relative after:absolute after:bottom-0 after:left-0 after:w-0 after:h-[2px] after:bg-accent hover:after:w-full after:transition-all" href={link.url}
                               target={link.target}>{link.name}</a>
                    )
                })
            }
        </nav>

        <!-- Right: Buttons -->
        <div class="flex items-center shrink-0">
            <div class="flex sm:hidden icon-button cursor-pointer relative group">
                <Icon class="w-6 h-6" name="material-symbols:menu-rounded"/>
                <nav class="absolute top-8 -left-full rounded-xl shadow-xl bg-base border border-border hidden group-hover:block animate-in fade-in">
                    {
                        filteredLinks.map((link) => {
                            return (
                                    <a class="flex items-center pl-3 pr-2 py-2 first:rounded-t-xl last:rounded-b-xl hover:bg-hover hover:text-accent transition-all"
                                       href={link.url}
                                       target={link.target}>
                                        {link.name}
                                        <Icon class="w-6 h-6 ml-auto text-secondary" name="material-symbols:chevron-right-rounded"/>
                                    </a>
                            )
                        })
                    }
                </nav>
            </div>
            <button id="search" class="ml-4 icon-button" aria-label="Search">
                <Icon class="w-6 h-6" name="material-symbols:search-rounded"/>
            </button>
            <button id="theme" class="ml-2 icon-button" aria-label="Toggle theme"></button>
        </div>
    </div>
</header>

<script is:inline>
    const searchButton = document.querySelector("#search");
    searchButton.addEventListener("click", () => {
        const searchContainer = document.querySelector("#search-container")
        if (searchContainer.classList.contains("hidden")) {
            window.openSearch?.()
            searchContainer.querySelector("input").focus()
        } else {
            window.closeSearch?.()
        }
    })

    document.documentElement.addEventListener("keydown", (e) => {
        if (e.key === "/" && document.activeElement.tagName !== "INPUT") {
            window.openSearch?.()
            setTimeout(() => {
                document.querySelector("#search-container input")?.focus()
            })
        }
        if (e.key === "Escape") {
            window.closeSearch?.()
        }
    })
</script>
